<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá Th·ªëng Qu·∫£n L√Ω Kho K·ªá</title>
 
    <link href="./dist/output.css" rel="stylesheet">
    <!-- Th∆∞ vi·ªán SheetJS cho ph√©p xu·∫•t file Excel -->
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .card { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06); border-radius: 12px; }
        /* Cu·ªôn ngang cho khu v·ª±c kho */
        .shelf-container {
            overflow-x: auto;
            white-space: nowrap;
            padding-bottom: 1rem;
        }
        .shelf-location {
            display: inline-block;
            width: 250px; /* Chi·ªÅu r·ªông c·ªë ƒë·ªãnh cho m·ªói th·∫ª kho */
            height: 250px; /* Chi·ªÅu cao c·ªë ƒë·ªãnh cho m·ªói th·∫ª kho */
            vertical-align: top;
        }
        .row-shelf {
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            padding: 1rem;
            background-color: #f9fafb;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <!-- Script t·∫£i Firebase Modules v√† Logic ·ª®ng d·ª•ng -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, query, onSnapshot, setDoc, serverTimestamp, getDoc, updateDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        const firebaseConfig = {
  apiKey: "AIzaSyAqPp5Ym-dapX30KzuzMp8oH1EWJO3dqfE",
  authDomain: "khonguyenlieubpc01.firebaseapp.com",
  projectId: "khonguyenlieubpc01",
  storageBucket: "khonguyenlieubpc01.firebasestorage.app",
  messagingSenderId: "840063614100",
  appId: "1:840063614100:web:60da34b6462042a1500881",
  measurementId: "G-ZN0RECEVQN"
};

// Initialize Firebase
//const app = initializeApp(firebaseConfig);
//const analytics = getAnalytics(app);
        // Bi·∫øn to√†n c·ª•c t·ª´ m√¥i tr∆∞·ªùng Canvas
        //const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        //const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        //const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
const initialAuthToken = null;
        let db, auth, firestoreUserId = null;
        let loggedInUser = null;
        let appState = 'login'; // 'login', 'dashboard', 'manage_inventory', 'reports', 'check_location'
        let inventoryData = {}; // Cache d·ªØ li·ªáu kho
        let currentModalHistory = []; // L·ªãch s·ª≠ c·ªßa th·∫ª kho ƒëang m·ªü

        // C·∫•u h√¨nh 3 t√†i kho·∫£n c·ªë ƒë·ªãnh (In-memory authentication)
        const USER_ACCOUNTS = {
            'anhle': { password: 'pass1', fullName: 'Le Ngoc Anh' },
            'minhhung': { password: 'pass2', fullName: 'ƒêinh Minh H∆∞ng' },
            'thanhtai': { password: 'pass3', fullName: 'Phan Th√†nh T√†i' }
        };

        // C·∫•u tr√∫c kho: 6 D√£y (A-F), 4 H√†ng (1-4), 24 C·ªôt (01-24)
        const AISLES = ['A', 'B', 'C', 'D', 'E', 'F'];
        const ROWS = ['1', '2', '3', '4'];
        const COLS = Array.from({ length: 24 }, (_, i) => (i + 1).toString().padStart(2, '0'));
        const TOTAL_LOCATIONS = AISLES.length * ROWS.length * COLS.length;
        
        // --- KH·ªûI T·∫†O FIREBASE & X√ÅC TH·ª∞C ---

const app = initializeApp(firebaseConfig);// V√≠ d·ª• v·ªÅ v·ªã tr√≠ khai b√°o (Kho·∫£ng D√≤ng 83-85)
 db = getFirestore(app);
 auth = getAuth(app);
const appID = "khonguyenlieubpc01"; // ƒê·∫£m b·∫£o D√íNG N√ÄY ƒê√É ƒê∆Ø·ª¢C L∆ØU
let firestoreUserid = null; // Bi·∫øn n√†y c≈©ng ph·∫£i ƒë∆∞·ª£c khai b√°o

        setLogLevel('debug'); // B·∫≠t log debug cho Firestore

        // X·ª≠ l√Ω x√°c th·ª±c ban ƒë·∫ßu (Sign in anonymously for security rules)
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("L·ªói x√°c th·ª±c Firebase:", error);
                }
            }
            firestoreUserId = auth.currentUser?.uid;
            renderApp(); // Hi·ªÉn th·ªã giao di·ªán l·∫ßn ƒë·∫ßu (m·∫∑c ƒë·ªãnh l√† login)
            if (firestoreUserId) {
                setupRealtimeListener();
            }
        });

        // H√†m l·∫•y ƒë∆∞·ªùng d·∫´n Collection cho d·ªØ li·ªáu Kho (Public)
       const getInventoryCollectionRef = (db, appID) => { 
    // D√íNG 113: S·∫Ω ho·∫°t ƒë·ªông v√¨ db v√† appID ƒë√£ ƒë∆∞·ª£c truy·ªÅn v√†o
    return collection(db, 
    'artifacts',       // 1. Collection
    'config_doc',      // 2. Document
    'data',            // 3. Collection
    'inventory_cards', // 4. Document
    'items'            // 5. Collection ID (HO·∫∂C b·∫•t k·ª≥ t√™n Collection n√†o b·∫°n mu·ªën)
);
};

        // L·∫Øng nghe d·ªØ li·ªáu t·ªìn kho theo th·ªùi gian th·ª±c
        const setupRealtimeListener = () => {
            if (!firestoreUserId) return;

            const q = query(getInventoryCollectionRef(db , appID));

            onSnapshot(q, (snapshot) => {
                const data = {};
                snapshot.forEach((doc) => {
                    data[doc.id] = doc.data();
                });
                inventoryData = data;
                if (appState === 'manage_inventory') {
                    renderManageInventory(); // C·∫≠p nh·∫≠t l·∫°i giao di·ªán qu·∫£n l√Ω kho n·∫øu ƒëang ·ªü ƒë√≥
                }
                if (appState === 'check_location') {
                    renderApp(); // C·∫≠p nh·∫≠t l·∫°i t·ªïng quan kho
                }
            }, (error) => {
                console.error("L·ªói khi l·∫Øng nghe d·ªØ li·ªáu t·ªìn kho:", error);
            });
        };

        // --- LOGIC X√ÅC TH·ª∞C IN-MEMORY ---

        window.handleLogin = (event) => {
            event.preventDefault();
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            const statusEl = document.getElementById('login-status');

            if (USER_ACCOUNTS[username] && USER_ACCOUNTS[username].password === password) {
                loggedInUser = USER_ACCOUNTS[username].fullName; // L∆∞u t√™n ƒë·∫ßy ƒë·ªß
                appState = 'dashboard';
                renderApp();
            } else {
                statusEl.innerText = 'T√†i kho·∫£n ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ƒë√∫ng.';
                statusEl.classList.remove('hidden');
            }
        };

        window.handleLogout = () => {
            loggedInUser = null;
            appState = 'login';
            renderApp();
        };

        // --- LOGIC CHUY·ªÇN TRANG/STATE ---

        window.navigateTo = (state) => {
            if (loggedInUser || state === 'login') {
                appState = state;
                renderApp();
            }
        };

        // --- H√ÄM RENDER CH√çNH ---

        const appContainer = document.getElementById('app-container');

        const renderApp = () => {
            if (!appContainer) return;

            let htmlContent = '';
            
            if (appState === 'login') {
                htmlContent = renderLogin();
            } else {
                htmlContent = renderMainLayout();
            }

            appContainer.innerHTML = htmlContent;
            
            // Render n·ªôi dung ch√≠nh sau khi layout ƒë∆∞·ª£c ch√®n
            if (appState !== 'login') {
                renderContent();
            }
            
            // C√†i ƒë·∫∑t l·∫°i s·ª± ki·ªán cho form ƒêƒÉng nh·∫≠p n·∫øu ƒëang ·ªü tr·∫°ng th√°i Login
            if (appState === 'login') {
                document.getElementById('login-form')?.addEventListener('submit', window.handleLogin);
            }
        };

        const renderLogin = () => `
            <div class="flex items-center justify-center min-h-screen bg-gray-50">
                <div class="w-full max-w-md p-8 space-y-6 bg-white card">
                    <h2 class="text-3xl font-bold text-center text-blue-700">ƒêƒÇNG NH·∫¨P H·ªÜ TH·ªêNG KHO</h2>
                    <p class="text-center text-sm text-gray-500">S·ª≠ d·ª•ng 1 trong 3 t√†i kho·∫£n m·∫´u</p>
                    <ul class="text-xs text-gray-500 list-disc list-inside p-2 bg-gray-50 rounded-lg">
                        <li>anhle (Qu·∫£n L√Ω KNL)</li>
                        <li>minhhung  (Th·ªß Kho Swine)</li>
                        <li>thanhtai (Th·ªß Kho )</li>
                    </ul>
                    <form id="login-form" class="space-y-4">
                        <div>
                            <label for="login-username" class="sr-only">T√™n ƒëƒÉng nh·∫≠p</label>
                            <input id="login-username" name="username" type="text" value="user1" required class="relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-lg focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="T√™n ƒëƒÉng nh·∫≠p">
                        </div>
                        <div>
                            <label for="login-password" class="sr-only">M·∫≠t kh·∫©u</label>
                            <input id="login-password" name="password" type="password" value="pass1" required class="relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-lg focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="M·∫≠t kh·∫©u">
                        </div>
                        <div id="login-status" class="hidden text-sm text-red-500 text-center"></div>
                        <div>
                            <button type="submit" class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-lg text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                ƒêƒÉng Nh·∫≠p
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        `;

        const renderMainLayout = () => {
            const getNavItemClass = (state) => appState === state ? 'bg-blue-700 text-white' : 'text-blue-100 hover:bg-blue-600';
            
            return `
                <div class="flex h-screen overflow-hidden">
                    <!-- Sidebar -->
                    <div class="flex flex-col w-64 bg-blue-800 text-white">
                        <div class="p-6 text-2xl font-bold border-b border-blue-700">
                            Kho Nguy√™n Li·ªáu
                        </div>
                        <nav class="flex-grow p-4 space-y-2">
                            <h3 class="text-xs font-semibold uppercase text-blue-300 mb-2">Xin ch√†o: ${loggedInUser}</h3>
                            <button onclick="navigateTo('dashboard')" class="w-full text-left py-2 px-4 rounded-lg transition-colors duration-200 ${getNavItemClass('dashboard')}">
                                B·∫£ng ƒêi·ªÅu Khi·ªÉn
                            </button>
                            <button onclick="navigateTo('manage_inventory')" class="w-full text-left py-2 px-4 rounded-lg transition-colors duration-200 ${getNavItemClass('manage_inventory')}">
                                Qu·∫£n L√Ω Kho K·ªá
                            </button>
                            <button onclick="navigateTo('reports')" class="w-full text-left py-2 px-4 rounded-lg transition-colors duration-200 ${getNavItemClass('reports')}">
                                B√°o C√°o T·ªìn/Nh·∫≠p
                            </button>
                            <button onclick="navigateTo('check_location')" class="w-full text-left py-2 px-4 rounded-lg transition-colors duration-200 ${getNavItemClass('check_location')}">
                                Ki·ªÉm Tra Kho K·ªá
                            </button>
                        </nav>
                        <div class="p-4 border-t border-blue-700">
                            <button onclick="handleLogout()" class="w-full py-2 px-4 border border-blue-600 text-sm font-medium rounded-lg text-white bg-red-600 hover:bg-red-700 transition duration-150">
                                ƒêƒÉng Xu·∫•t
                            </button>
                        </div>
                    </div>

                    <!-- Main Content -->
                    <div class="flex-1 overflow-y-auto p-6">
                        <h1 id="page-title" class="text-3xl font-semibold text-gray-800 mb-6"></h1>
                        <div id="content-area">
                            <!-- N·ªôi dung chi ti·∫øt s·∫Ω ƒë∆∞·ª£c ch√®n v√†o ƒë√¢y -->
                            <div id="loading-indicator" class="flex justify-center items-center py-20 text-gray-500">
                                <svg class="animate-spin h-5 w-5 mr-3" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">...</svg> ƒêang t·∫£i...
                            </div>
                        </div>
                    </div>
                </div>
            `;
        };

        const renderContent = () => {
            const contentArea = document.getElementById('content-area');
            const pageTitle = document.getElementById('page-title');
            if (!contentArea || !pageTitle) return;
            
            contentArea.innerHTML = '<div id="loading-indicator" class="flex justify-center items-center py-20 text-gray-500"><svg class="animate-spin h-5 w-5 mr-3" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> ƒêang t·∫£i...</div>';

            switch (appState) {
                case 'dashboard':
                    pageTitle.innerText = 'B·∫£ng ƒêi·ªÅu Khi·ªÉn Ch√≠nh';
                    contentArea.innerHTML = renderDashboard();
                    break;
                case 'manage_inventory':
                    pageTitle.innerText = 'Qu·∫£n L√Ω Kho K·ªá - Th·∫ª Kho';
                    renderManageInventory(contentArea);
                    break;
                case 'reports':
                    pageTitle.innerText = 'B√°o C√°o T·ªìn v√† Nh·∫≠p Xu·∫•t';
                    contentArea.innerHTML = renderReports();
                    break;
                case 'check_location':
                    pageTitle.innerText = 'Ki·ªÉm Tra T·ªìn Kho K·ªá';
                    contentArea.innerHTML = renderCheckLocation();
                    break;
                default:
                    pageTitle.innerText = 'L·ªói 404';
                    contentArea.innerHTML = '<p class="text-red-500">Trang kh√¥ng t·ªìn t·∫°i.</p>';
            }
        };

        // H√†m t·∫°o ID v·ªã tr√≠ m·ªõi: H√†ng-D√£y-C·ªôt (v√≠ d·ª•: 1A01, 2B15)
        const getLocationId = (row, aisle, col) => {
            return `${row}${aisle}${col}`;
        }
        
        // Helper to generate all location IDs
        const getAllLocationIds = () => {
            const allIds = [];
            AISLES.forEach(aisle => {
                ROWS.forEach(row => {
                    COLS.forEach(col => {
                        allIds.push(getLocationId(row, aisle, col));
                    });
                });
            });
            return allIds;
        };

        // --- H√ÄM T√çNH TO√ÅN V√Ä PH√ÇN LO·∫†I FIFO/COLOR ---
        
        const getLocationCardClasses = (loc) => {
            if (!loc.isOccupied) {
                return { cardClass: 'border-gray-300 bg-gray-50 hover:bg-gray-100', materialClass: 'text-gray-500', ageText: '' };
            }
            
            const age = loc.ageInDays;
            let cardClass, materialClass;
            let ageText = loc.data.fifoDate ? `(FIFO: ${loc.ageInDays} ng√†y)` : '';
            
            if (age === null) {
                // C√≥ v·∫≠t li·ªáu nh∆∞ng kh√¥ng c√≥ fifoDate (d·ªØ li·ªáu c≈©/l·ªói)
                cardClass = 'border-yellow-500 bg-yellow-50 hover:shadow-lg';
                materialClass = 'text-yellow-700';
                ageText = '(Ch∆∞a c√≥ ng√†y FIFO)';
            } else if (age >= 60) {
                // >= 60 ng√†y: C·∫ßn xu·∫•t g·∫•p (Red)
                cardClass = 'border-red-500 bg-red-100 hover:shadow-xl';
                materialClass = 'text-red-700';
            } else if (age >= 30) {
                // 30 - 59 ng√†y: S·∫Øp ƒë·∫øn h·∫°n (Orange)
                cardClass = 'border-orange-400 bg-orange-100 hover:shadow-lg';
                materialClass = 'text-orange-700';
            } else {
                // < 30 ng√†y: H√†ng m·ªõi (Green)
                cardClass = 'border-green-400 bg-green-50 hover:shadow-md';
                materialClass = 'text-green-700';
            }
            
            return { cardClass, materialClass, ageText };
        };

        const renderLocationCard = (loc) => {
            const { cardClass, materialClass, ageText } = getLocationCardClasses(loc);
            
            const data = loc.data;
            const materialName = data.materialName || 'V·ªã tr√≠ tr·ªëng';
            const currentQuantity = data.currentQuantity || 0;
            
            // Hi·ªÉn th·ªã ng√†y FIFO n·∫øu c√≥
            const fifoInfo = loc.isOccupied && loc.ageInDays !== null ? 
                `<p class="text-xs ${loc.ageInDays >= 60 ? 'text-red-500 font-bold' : 'text-gray-500'}">FIFO: ${new Date(data.fifoDate).toLocaleDateString('vi-VN')} (${loc.ageInDays} ng√†y)</p>` : 
                '';

            return `
                <div onclick="window.showLocationModal('${loc.id}')" 
                    class="shelf-location flex-shrink-0 border-2 rounded-lg p-3 cursor-pointer transition-all ${cardClass}">
                    <p class="text-sm font-bold text-gray-800 mb-2 truncate">${loc.id}</p>
                    <p class="text-base font-semibold truncate ${materialClass}">${materialName}</p>
                    ${loc.isOccupied ? `
                        <p class="text-sm text-gray-600 mt-1">T·ªìn: <span class="font-bold text-lg text-blue-600">${currentQuantity.toLocaleString('vi-VN')}</span> ${data.unit}</p>
                        ${fifoInfo}
                        <p class="text-xs text-gray-500">Lot: ${data.lotNo} - NCC: ${data.supplier}</p>
                        <button class="mt-2 w-full py-1 bg-blue-500 text-white text-xs rounded-lg hover:bg-blue-600">Chi ti·∫øt & Thao t√°c</button>
                    ` : `
                        <p class="text-sm text-gray-500 italic mt-2">Ch∆∞a c√≥ nguy√™n li·ªáu</p>
                    `}
                </div>
            `;
        }

        // Helper for filtering and sorting (NEW)
        const getFilteredAndSortedLocations = (currentAisle, searchTerm) => {
            const now = Date.now();
            const isAllView = currentAisle === 'ALL';
            
            // 1. Get relevant locations based on Aisle selection
            let locationIds;
            if (isAllView) {
                locationIds = getAllLocationIds();
            } else {
                locationIds = ROWS.flatMap(row => COLS.map(col => getLocationId(row, currentAisle, col)));
            }
            
            // 2. Filter and enhance data for sorting/display
            const enrichedLocations = locationIds.map(locationId => {
                const data = inventoryData[locationId] || { materialName: null, currentQuantity: 0, fifoDate: null };
                
                let ageInDays = null;
                if (data.fifoDate) {
                    const fifoTime = new Date(data.fifoDate).getTime();
                    ageInDays = Math.floor((now - fifoTime) / (1000 * 60 * 60 * 24));
                }
                
                return {
                    id: locationId,
                    data,
                    isOccupied: !!data.materialName && data.currentQuantity > 0,
                    ageInDays
                };
            });
            
            // 3. Filtering by materialName
            let filteredLocations = enrichedLocations;
            if (searchTerm) {
                const lowerCaseSearch = searchTerm.toLowerCase().trim();
                // If searching, only show occupied locations that match the search term.
                filteredLocations = enrichedLocations.filter(loc => 
                    loc.isOccupied && loc.data.materialName && loc.data.materialName.toLowerCase().includes(lowerCaseSearch)
                );
            } else if (!isAllView) {
                 // In Aisle view (A-F), we show everything in that Aisle
                 filteredLocations = enrichedLocations;
            } else if (isAllView && !searchTerm) {
                 // In ALL view without search, show all locations
                 filteredLocations = enrichedLocations;
            }


            // 4. Sorting (FIFO for occupied/searched items, then by location ID)
            filteredLocations.sort((a, b) => {
                // Sorting for ALL/Search view: Occupied (FIFO) -> Empty (Location ID)
                if (isAllView || searchTerm) {
                    if (a.isOccupied && !b.isOccupied) return -1; // Occupied first
                    if (!a.isOccupied && b.isOccupied) return 1;  // Empty last

                    if (a.isOccupied && b.isOccupied) {
                        // Both occupied: Oldest first (FIFO)
                        const dateA = new Date(a.data.fifoDate || new Date()).getTime();
                        const dateB = new Date(b.data.fifoDate || new Date()).getTime();
                        return dateA - dateB;
                    }
                    
                    // Both empty or for default Aisle view: Sort by location ID
                    return a.id.localeCompare(b.id);
                }
                
                // Default sort for Aisle view (A-F), maintaining the grid order
                return a.id.localeCompare(b.id);
            });
            
            return filteredLocations;
        };
        
        // Render view for a single Aisle (A-F)
        const renderAisleView = (currentAisle, filteredLocations) => {
            let html = `<h3 class="text-xl font-semibold text-gray-700 mb-4">D√£y Kho ${currentAisle} - Chi ti·∫øt 4 H√†ng</h3>`;
            
            ROWS.forEach(row => {
                html += `
                    <div class="row-shelf">
                        <h4 class="text-lg font-bold text-gray-800 mb-4">H√†ng ${row} (V·ªã tr√≠ ${row}${currentAisle}01 - ${row}${currentAisle}24)</h4>
                        <div class="shelf-container">
                            <div class="flex space-x-4 pb-2">`;
                
                // Filter locations belonging to this specific Row and Aisle
                const rowLocations = filteredLocations.filter(loc => loc.id.startsWith(`${row}${currentAisle}`));
                
                rowLocations.forEach(loc => {
                    html += renderLocationCard(loc);
                });
                
                html += `</div></div></div>`;
            });
            return html;
        };

        // Render view for ALL locations (used for ALL tab and Search results) (NEW)
        const renderAllInventoryView = (currentAisle, searchTerm, filteredLocations) => {
            let title = searchTerm ? `K·∫øt qu·∫£ t√¨m ki·∫øm cho: "${searchTerm}" (${filteredLocations.length} v·ªã tr√≠)` : 
                                    `T·∫•t C·∫£ V·ªã Tr√≠ Kho (576 v·ªã tr√≠) - S·∫Øp x·∫øp theo FIFO (h√†ng c≈© nh·∫•t l√™n tr∆∞·ªõc)`;

            let html = `<h3 class="text-xl font-semibold text-gray-700 mb-4">${title}</h3>`;
            
            // N·∫øu c√≥ searchTerm, ch·ªâ hi·ªÉn th·ªã c√°c v·ªã tr√≠ c√≥ h√†ng ƒë∆∞·ª£c l·ªçc. Ng∆∞·ª£c l·∫°i, hi·ªÉn th·ªã t·∫•t c·∫£.
            const displayLocations = searchTerm 
                ? filteredLocations 
                : filteredLocations.filter(loc => loc.isOccupied).concat(filteredLocations.filter(loc => !loc.isOccupied));
            
            if (displayLocations.length === 0 && searchTerm) {
                html += `<div class="p-6 bg-yellow-50 text-center text-gray-600 rounded-lg">Kh√¥ng t√¨m th·∫•y nguy√™n li·ªáu n√†o ph√π h·ª£p v·ªõi ƒëi·ªÅu ki·ªán t√¨m ki·∫øm.</div>`;
            } else if (displayLocations.length === 0 && !searchTerm) {
                 html += `<div class="p-6 bg-green-50 text-center text-gray-600 rounded-lg">To√†n b·ªô kho k·ªá hi·ªán ƒëang tr·ªëng.</div>`;
            } else {
                html += `<div class="p-4 bg-white card">
                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-4">`;
                
                displayLocations.forEach(loc => {
                    html += renderLocationCard(loc);
                });

                html += `</div></div>`;
            }
            
            return html;
        };

        // --- RENDER DASHBOARD ---
        const renderDashboard = () => `
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                ${renderStatCard('Qu·∫£n L√Ω Kho', 'manage_inventory', 'bg-blue-600', 'Qu·∫£n l√Ω 576 v·ªã tr√≠ t·ªìn kho')}
                ${renderStatCard('B√°o C√°o T·ªìn', 'reports', 'bg-green-600', 'Xem t·ªìn kho theo Lot/T·ªïng')}
                ${renderStatCard('B√°o C√°o Nh·∫≠p', 'reports', 'bg-yellow-600', 'L·ªãch s·ª≠ nh·∫≠p h√†ng')}
                ${renderStatCard('Ki·ªÉm Tra Kho', 'check_location', 'bg-purple-600', 'Xem nhanh tr·∫°ng th√°i kho k·ªá')}
            </div>
            <div class="mt-8 p-6 bg-white card">
                <h3 class="text-xl font-semibold mb-4">Th√¥ng tin h·ªá th·ªëng</h3>
                <p>T·ªïng s·ªë v·ªã tr√≠ kho: ${TOTAL_LOCATIONS}</p>
                <p>Ng∆∞·ªùi d√πng hi·ªán t·∫°i: ${loggedInUser}</p>
                <p class="text-xs text-gray-500 mt-2">ID Firebase t·∫°m th·ªùi: ${firestoreUserId}</p>
            </div>
        `;

        const renderStatCard = (title, state, bgColor, description) => `
            <div onclick="navigateTo('${state}')" class="p-6 ${bgColor} text-white card cursor-pointer hover:bg-opacity-90 transition duration-150">
                <h3 class="text-2xl font-bold mb-2">${title}</h3>
                <p class="text-sm">${description}</p>
            </div>
        `;

        // --- RENDER QU·∫¢N L√ù KHO K·ªÜ (V·ªä TR√ç) ---
        
        window.selectAisle = (aisle) => {
            const contentArea = document.getElementById('content-area');
            if (!contentArea) return;
            contentArea.dataset.currentAisle = aisle;
            contentArea.dataset.searchTerm = ''; // X√≥a search khi chuy·ªÉn Aisle
            renderManageInventory(contentArea);
        };

        window.handleSearch = (term) => {
            const contentArea = document.getElementById('content-area');
            if (!contentArea) return;
            contentArea.dataset.searchTerm = term;
            
            // T·ª± ƒë·ªông chuy·ªÉn sang ch·∫ø ƒë·ªô ALL n·∫øu t√¨m ki·∫øm c√≥ gi√° tr·ªã
            if (term && contentArea.dataset.currentAisle !== 'ALL') {
                contentArea.dataset.currentAisle = 'ALL';
            } else if (!term && contentArea.dataset.currentAisle === 'ALL') {
                // N·∫øu x√≥a term, quay v·ªÅ Aisle A n·∫øu ƒëang ·ªü ALL
                contentArea.dataset.currentAisle = AISLES[0];
            }
            renderManageInventory(contentArea);
        };


        // Hi·ªÉn th·ªã 4 h√†ng c·ªßa d√£y ƒë∆∞·ª£c ch·ªçn
        const renderManageInventory = (contentArea) => {
            if (!contentArea) contentArea = document.getElementById('content-area');
            if (!contentArea) return;

            // L·∫•y D√£y hi·ªán t·∫°i, m·∫∑c ƒë·ªãnh l√† A. Th√™m 'ALL'
            const currentAisle = contentArea.dataset.currentAisle || AISLES[0];
            const searchTerm = contentArea.dataset.searchTerm || '';

            // X√¢y d·ª±ng giao di·ªán ch·ªçn D√£y (A-F + ALL)
            let html = `<div class="p-4 bg-white card mb-6">
                <div class="flex flex-col md:flex-row md:items-center justify-between mb-4 space-y-3 md:space-y-0">
                    <h3 class="text-lg font-semibold">Ch·ªçn D√£y Kho ho·∫∑c T·ªïng quan (FIFO Search)</h3>
                    <input type="text" id="search-input" value="${searchTerm}" oninput="window.handleSearch(this.value)" 
                        placeholder="üîç T√¨m ki·∫øm T√™n Nguy√™n Li·ªáu..." 
                        class="w-full md:w-1/3 p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                </div>
                
                <div class="grid grid-cols-7 gap-3 mb-4">`; // 6 Aisle + 1 ALL

            // Render n√∫t ch·ªçn D√£y (A-F)
            AISLES.forEach(aisle => {
                const isActive = currentAisle === aisle && searchTerm === '' ? 'bg-blue-600 text-white' : 'bg-gray-200 hover:bg-gray-300';
                html += `<button onclick="window.selectAisle('${aisle}')" class="py-2 rounded-lg font-medium transition-colors ${isActive}">D√£y ${aisle}</button>`;
            });

            // Render n√∫t ALL
            const isAllActive = currentAisle === 'ALL' || searchTerm !== '' ? 'bg-blue-600 text-white' : 'bg-gray-200 hover:bg-gray-300';
            html += `<button onclick="window.selectAisle('ALL')" class="py-2 rounded-lg font-bold transition-colors ${isAllActive}">T·∫•t C·∫£ (ALL)</button>`;

            html += `</div></div>`;
            
            // Check if we are in ALL view or have a search term
            const isAllView = currentAisle === 'ALL' || searchTerm;
            
            const filteredLocations = getFilteredAndSortedLocations(currentAisle, searchTerm);

            if (isAllView) {
                html += renderAllInventoryView(currentAisle, searchTerm, filteredLocations);
            } else {
                html += renderAisleView(currentAisle, filteredLocations);
            }
            
            contentArea.innerHTML = html;
        };

        // --- RENDER B√ÅO C√ÅO T·ªíN/NH·∫¨P ---
        const renderReports = () => {
            // 1. X·ª≠ l√Ω d·ªØ li·ªáu: L·ªçc c√°c v·ªã tr√≠ c√≥ h√†ng, t√≠nh to√°n v√† s·∫Øp x·∫øp
            const reportItems = Object.entries(inventoryData)
                .filter(([id, data]) => data && data.materialName && data.currentQuantity > 0)
                .map(([locationId, data]) => {
                    const totalWeight = (data.currentQuantity || 0) * (data.unitWeight || 0);
                    return {
                        ...data,
                        locationId,
                        totalWeight
                    };
                })
                .sort((a, b) => {
                    // S·∫Øp x·∫øp theo T√™n nguy√™n li·ªáu, sau ƒë√≥ l√† Ng√†y nh·∫≠p (FIFO)
                    if (a.materialName < b.materialName) return -1;
                    if (a.materialName > b.materialName) return 1;
                    const dateA = new Date(a.fifoDate || 0).getTime();
                    const dateB = new Date(b.fifoDate || 0).getTime();
                    return dateA - dateB;
                });

            // 2. X√¢y d·ª±ng HTML
            let html = `
                <div class="p-6 bg-white card">
                    <div class="flex flex-col md:flex-row justify-between md:items-center mb-4 space-y-3 md:space-y-0">
                        <h3 class="text-2xl font-bold text-blue-700">B√ÅO C√ÅO KI·ªÇM KHO NGUY√äN LI·ªÜU</h3>
                        <button onclick="window.exportInventoryReport()" class="flex items-center space-x-2 py-2 px-4 bg-green-600 text-white font-medium rounded-lg hover:bg-green-700 transition duration-150">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L10 11.586l2.293-2.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                                <path fill-rule="evenodd" d="M10 2a1 1 0 011 1v7a1 1 0 11-2 0V3a1 1 0 011-1z" clip-rule="evenodd" />
                            </svg>
                            <span>Xu·∫•t Excel B√°o C√°o T·ªìn</span>
                        </button>
                    </div>
                    
                    <div class="overflow-x-auto border rounded-lg">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">STT</th>
                                    <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">T√™n nguy√™n li·ªáu</th>
                                    <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Ng√†y nh·∫≠p (FIFO)</th>
                                    <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Tr·ªçng l∆∞·ª£ng bao (kg)</th>
                                    <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">V·ªã tr√≠</th>
                                    <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">S·ªë bao</th>
                                    <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Tr·ªçng l∆∞·ª£ng (kg)</th>
                                    <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Ghi ch√∫</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
            `;

            if (reportItems.length === 0) {
                html += `<tr><td colspan="8" class="px-4 py-6 text-center text-gray-500 italic">Kh√¥ng c√≥ d·ªØ li·ªáu t·ªìn kho.</td></tr>`;
            } else {
                reportItems.forEach((item, index) => {
                    const fifoDate = item.fifoDate ? new Date(item.fifoDate).toLocaleDateString('vi-VN') : 'N/A';
                    html += `
                        <tr class="hover:bg-gray-50">
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-700">${index + 1}</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.materialName}</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-700">${fifoDate}</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-right text-gray-700">${item.unitWeight ? item.unitWeight.toFixed(2) : 'N/A'}</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm font-semibold text-gray-700">${item.locationId}</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm font-bold text-blue-600 text-right">${item.currentQuantity} ${item.unit}</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm font-bold text-red-600 text-right">${item.totalWeight.toFixed(2)}</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500 truncate" title="${item.note || ''}">${item.note || ''}</td>
                        </tr>
                    `;
                });
            }

            html += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            return html;
        };
        
        // --- RENDER KI·ªÇM TRA KHO K·ªÜ (T·ªîNG QUAN) ---
        const renderCheckLocation = () => {
             let html = `<p class="text-gray-600 mb-4">T·ªïng quan tr·∫°ng th√°i s·ª≠ d·ª•ng c·ªßa kho k·ªá (6 D√£y x 4 H√†ng).</p>
                <div class="p-6 bg-white card">
                    <h3 class="text-xl font-semibold mb-4">S∆° ƒë·ªì v·ªã tr√≠</h3>
                    <div class="grid grid-cols-6 gap-2 text-center text-sm font-medium">
                        ${AISLES.map(aisle => `<div class="p-2 bg-gray-200 rounded-t-lg">D√£y ${aisle}</div>`).join('')}
                    </div>
                    <div class="grid grid-cols-6 gap-2 mt-0">
                        ${AISLES.map(aisle => `
                            <div class="grid grid-rows-4 gap-2">
                                ${ROWS.map(row => {
                                    // ƒê·∫øm s·ªë c·ªôt c√≥ nguy√™n li·ªáu trong H√†ng-D√£y n√†y (24 c·ªôt)
                                    const occupiedCount = COLS.filter(col => inventoryData[getLocationId(row, aisle, col)]?.materialName).length;
                                    const percentage = (occupiedCount / COLS.length) * 100;
                                    const color = percentage > 80 ? 'bg-red-500' : (percentage > 30 ? 'bg-yellow-500' : 'bg-green-500');
                                    
                                    return `
                                        <div class="p-2 text-xs text-white rounded-lg shadow ${color}" 
                                             title="${occupiedCount}/${COLS.length} c·ªôt c√≥ h√†ng">
                                            H√†ng ${row} (${Math.round(percentage)}%)
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            return html;
        };


        // --- MODAL TH·∫∫ KHO V√Ä THAO T√ÅC ---
        const modal = document.getElementById('location-modal');
        const modalContent = document.getElementById('location-modal-content');

        window.showLocationModal = async (locationId) => {
            const data = inventoryData[locationId] || { materialName: null, currentQuantity: 0, totalImported: 0, totalExported: 0, lotNo: null, note: null, unit: 'bao', supplier: null, unitWeight: 0, fifoDate: null }; // ƒê∆°n v·ªã m·∫∑c ƒë·ªãnh l√† 'bao' n·∫øu ch∆∞a c√≥ d·ªØ li·ªáu
            
            // L·∫•y l·ªãch s·ª≠
            let historyHtml = '<p class="text-center text-gray-500">ƒêang t·∫£i l·ªãch s·ª≠...</p>';
            currentModalHistory = []; // Reset l·ªãch s·ª≠

            // Hi·ªán modal loading tr∆∞·ªõc
            modalContent.innerHTML = renderLocationModal(locationId, data, historyHtml);
            modal.classList.remove('hidden');
            
            try {
                const historyRef = doc(collection(getInventoryCollectionRef(), locationId, 'history'), 'default_history_doc');
                const docSnap = await getDoc(historyRef);
                const historySnapshot = docSnap.exists() ? docSnap.data().entries || [] : [];
                
                // L·ªçc b·ªè nh·ªØng entry kh√¥ng c√≥ ƒë·ªß d·ªØ li·ªáu (v√≠ d·ª•: entry.type tr·ªëng)
                currentModalHistory = historySnapshot.filter(entry => entry.type); // L∆∞u l·ªãch s·ª≠ v√†o bi·∫øn to√†n c·ª•c

                historyHtml = currentModalHistory.length > 0 ? `
                    <ul class="space-y-3">
                        ${currentModalHistory.slice(0, 10).reverse().map(entry => `
                            <li class="p-3 rounded-lg ${entry.type === 'import' ? 'bg-blue-50' : 'bg-red-50'} border-l-4 ${entry.type === 'import' ? 'border-blue-400' : 'border-red-400'}">
                                <span class="font-semibold">${entry.type === 'import' ? 'NH·∫¨P' : 'XU·∫§T'}</span>: ${new Date(entry.date).toLocaleDateString('vi-VN')}
                                <p class="text-sm mt-1">
                                    ${entry.type === 'import' ? 
                                        `S·ªë l∆∞·ª£ng: <strong>${entry.quantity}</strong> ${entry.unit} | Tr·ªçng l∆∞·ª£ng bao (TB): ${entry.bagWeight.toFixed(2)} kg | T·ªïng Tr·ªçng l∆∞·ª£ng: ${entry.totalWeight.toFixed(2)} kg | Lot: ${entry.lotNo}` : 
                                        `S·ªë bao: <strong>${entry.numBags}</strong> | Tr·ªçng l∆∞·ª£ng: ${entry.weight} kg | Ng∆∞·ªùi ki·ªÉm: ${entry.checker}`}
                                </p>
                                <p class="text-xs text-gray-500">Ghi ch√∫: ${entry.note || 'Kh√¥ng c√≥'}</p>
                            </li>
                        `).join('')}
                    </ul>
                ` : '<p class="text-center text-gray-500">Ch∆∞a c√≥ l·ªãch s·ª≠ nh·∫≠p/xu·∫•t t·∫°i v·ªã tr√≠ n√†y.</p>';
                
            } catch (error) {
                console.error("L·ªói t·∫£i l·ªãch s·ª≠:", error);
                historyHtml = '<p class="text-red-500">L·ªói khi t·∫£i l·ªãch s·ª≠ giao d·ªãch.</p>';
            }
            
            // C·∫≠p nh·∫≠t modal v·ªõi l·ªãch s·ª≠ ƒë√£ t·∫£i
            modalContent.innerHTML = renderLocationModal(locationId, data, historyHtml);
        };

        window.closeModal = () => {
            modal.classList.add('hidden');
        };

        const renderLocationModal = (locationId, data, historyHtml) => {
            const isFilled = data.materialName;
            
            const fifoDateDisplay = data.fifoDate 
                ? new Date(data.fifoDate).toLocaleDateString('vi-VN') 
                : 'N/A';
            
            return `
                <h3 class="text-2xl font-bold text-center text-blue-700 mb-4">TH·∫∫ KHO: ${locationId}</h3>
                
                <!-- N√∫t Xu·∫•t Excel -->
                <div class="flex justify-end mb-4">
                    <button onclick="window.exportToExcel('${locationId}')" class="flex items-center space-x-2 py-2 px-4 bg-green-600 text-white font-medium rounded-lg hover:bg-green-700 transition duration-150">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L10 11.586l2.293-2.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                            <path fill-rule="evenodd" d="M10 2a1 1 0 011 1v7a1 1 0 11-2 0V3a1 1 0 011-1z" clip-rule="evenodd" />
                        </svg>
                        <span>Xu·∫•t Excel Th·∫ª Kho</span>
                    </button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Th√¥ng tin t·ªïng quan -->
                    <div class="p-4 bg-gray-50 card">
                        <h4 class="text-lg font-semibold border-b pb-2 mb-3">T·ªìn Kho Hi·ªán T·∫°i</h4>
                        <p><strong>T√™n Nguy√™n Li·ªáu:</strong> <span class="text-lg font-bold text-green-700">${data.materialName || 'Tr·ªëng'}</span></p>
                        <p><strong>Ng√†y Nh·∫≠p Kho FIFO:</strong> <span class="text-lg font-bold text-red-500">${fifoDateDisplay}</span></p>
                        <p><strong>Tr·ªçng L∆∞·ª£ng 1 ƒê∆°n V·ªã (Ti√™u chu·∫©n):</strong> ${data.unitWeight > 0 ? data.unitWeight.toFixed(2) + ' kg' : 'N/A'}</p>
                        <p><strong>Nh√† Cung C·∫•p:</strong> ${data.supplier || 'N/A'}</p>
                        <p><strong>S·ªë Lot Hi·ªán T·∫°i:</strong> ${data.lotNo || 'N/A'}</p>
                        <p class="mt-2"><strong>T·ªïng Nh·∫≠p (ƒê√£):</strong> ${data.totalImported || 0} ${data.unit || ''}</p>
                        <p><strong>T·ªïng Xu·∫•t (ƒê√£):</strong> ${data.totalExported || 0} ${data.unit || ''}</p>
                        <p class="mt-3 text-xl font-extrabold text-red-600">
                            T·ªíN HI·ªÜN T·∫†I: ${data.currentQuantity} ${data.unit || ''}
                        </p>
                    </div>

                    <!-- L·ªãch s·ª≠ giao d·ªãch -->
                    <div class="p-4 bg-white card max-h-[400px] overflow-y-auto">
                        <h4 class="text-lg font-semibold border-b pb-2 mb-3">L·ªãch S·ª≠ Nh·∫≠p/Xu·∫•t (10 giao d·ªãch g·∫ßn nh·∫•t)</h4>
                        ${historyHtml}
                    </div>
                </div>

                <!-- Form Nh·∫≠p/Xu·∫•t v√† Thao t√°c -->
                <div class="mt-6">
                    <h4 class="text-xl font-bold text-gray-800 mb-4">Thao T√°c Kho</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        
                        <!-- Form Nh·∫≠p Kho -->
                        <div class="p-4 bg-blue-100 card">
                            <h5 class="text-lg font-semibold text-blue-800 mb-3">NH·∫¨P KHO</h5>
                            <form id="import-form" onsubmit="window.handleImport(event, '${locationId}')" class="space-y-3">
                                ${!isFilled ? `
                                    <input type="text" name="materialName" placeholder="T√™n Nguy√™n Li·ªáu (*)" required class="w-full p-2 border rounded-lg">
                                    <input type="number" name="unitWeight" step="0.01" placeholder="Tr·ªçng l∆∞·ª£ng 1 ƒë∆°n v·ªã (kg) (*)" required class="w-full p-2 border rounded-lg">
                                    <input type="text" name="supplier" placeholder="Nh√† Cung C·∫•p (*)" required class="w-full p-2 border rounded-lg">
                                    <input type="text" name="unit" value="bao" placeholder="ƒê∆°n v·ªã (M·∫∑c ƒë·ªãnh: bao) (*)" required class="w-full p-2 border rounded-lg">
                                ` : `
                                    <p class="text-sm text-blue-700">Nguy√™n li·ªáu ƒëang nh·∫≠p: <strong>${data.materialName}</strong></p>
                                    <p class="text-sm text-blue-700">ƒê∆°n v·ªã: <strong>${data.unit}</strong> - Tr·ªçng l∆∞·ª£ng 1 ƒë∆°n v·ªã: <strong>${data.unitWeight.toFixed(2)} kg</strong></p>
                                `}
                                <input type="text" name="lotNo" placeholder="Lot No (*)" required class="w-full p-2 border rounded-lg">
                                <input type="number" name="quantity" min="1" placeholder="S·ªë l∆∞·ª£ng nh·∫≠p (ƒë∆°n v·ªã/bao) (*)" required class="w-full p-2 border rounded-lg">
                                <!-- Tr∆∞·ªùng m·ªõi: T·ªïng tr·ªçng l∆∞·ª£ng nh·∫≠p -->
                                <input type="number" name="totalWeightInput" step="0.01" placeholder="T·ªîNG tr·ªçng l∆∞·ª£ng nh·∫≠p (kg) (*)" required class="w-full p-2 border rounded-lg">
                                <textarea name="note" placeholder="Ghi ch√∫ (T·ªìn: S·ªë bao/Tr·ªçng l∆∞·ª£ng/Ghi ch√∫)" class="w-full p-2 border rounded-lg"></textarea>
                                <button type="submit" class="w-full py-2 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition duration-150">Th·ª±c hi·ªán Nh·∫≠p Kho</button>
                            </form>
                        </div>
                        
                        <!-- Form Xu·∫•t Kho -->
                        <div class="p-4 bg-red-100 card">
                            <h5 class="text-lg font-semibold text-red-800 mb-3">XU·∫§T KHO</h5>
                            <form id="export-form" onsubmit="window.handleExport(event, '${locationId}', '${data.unit || ''}')" class="space-y-3">
                                <p class="text-sm text-red-700">Nguy√™n li·ªáu: <strong>${data.materialName || 'Tr·ªëng'}</strong></p>
                                <input type="number" name="numBags" min="1" placeholder="S·ªë bao/th√πng xu·∫•t (*)" required class="w-full p-2 border rounded-lg">
                                <input type="number" name="weight" step="0.01" min="1" placeholder="T·ªïng tr·ªçng l∆∞·ª£ng xu·∫•t (kg) (*)" required class="w-full p-2 border rounded-lg">
                                <p class="text-sm font-medium text-gray-700">Ng∆∞·ªùi ki·ªÉm: <strong>${loggedInUser}</strong></p>
                                <textarea name="note" placeholder="Ghi ch√∫ xu·∫•t (T·ªìn: S·ªë bao/Tr·ªçng l∆∞·ª£ng/Ghi ch√∫)" class="w-full p-2 border rounded-lg"></textarea>
                                <button type="submit" class="w-full py-2 bg-red-600 text-white font-medium rounded-lg hover:bg-red-700 transition duration-150" ${!isFilled ? 'disabled title="V·ªã tr√≠ tr·ªëng, kh√¥ng th·ªÉ xu·∫•t kho"' : ''}>Th·ª±c hi·ªán Xu·∫•t Kho</button>
                            </form>
                        </div>
                    </div>
                </div>
                
                <div class="mt-6 text-right">
                    <button onclick="window.closeModal()" class="py-2 px-6 bg-gray-200 text-gray-800 font-medium rounded-lg hover:bg-gray-300 transition duration-150">ƒê√≥ng</button>
                </div>
            `;
        };
        
        // --- LOGIC X·ª¨ L√ù NH·∫¨P/XU·∫§T KHO ---
        
        // C·∫≠p nh·∫≠t ho·∫∑c Kh·ªüi t·∫°o Th·∫ª kho
        window.handleImport = async (event, locationId) => {
            event.preventDefault();
            const form = event.target;
            
            const isNewMaterial = !inventoryData[locationId]?.materialName;
            
            const materialName = isNewMaterial ? form.materialName.value.trim() : inventoryData[locationId].materialName;
            const unitWeight = isNewMaterial ? parseFloat(form.unitWeight.value) : inventoryData[locationId].unitWeight;
            const supplier = isNewMaterial ? form.supplier.value.trim() : inventoryData[locationId].supplier;
            const unit = isNewMaterial ? form.unit.value.trim() : inventoryData[locationId].unit; 
            
            const lotNo = form.lotNo.value.trim();
            const quantity = parseFloat(form.quantity.value); // S·ªë l∆∞·ª£ng nh·∫≠p (ƒë∆°n v·ªã/bao)
            const totalWeightInput = parseFloat(form.totalWeightInput.value); // T·ªïng tr·ªçng l∆∞·ª£ng nh·∫≠p
            const note = form.note.value.trim();
            
            const currentData = inventoryData[locationId] || { currentQuantity: 0, totalImported: 0, totalExported: 0, fifoDate: null }; // Th√™m fifoDate
            
            if (isNaN(quantity) || quantity <= 0 || isNaN(totalWeightInput) || totalWeightInput <= 0) {
                 showSimpleModal('L·ªói Nh·∫≠p Li·ªáu', 'S·ªë l∆∞·ª£ng nh·∫≠p v√† T·ªïng tr·ªçng l∆∞·ª£ng nh·∫≠p ph·∫£i l·ªõn h∆°n 0.');
                 return;
            }

            const bagWeight = totalWeightInput / quantity; // T√≠nh tr·ªçng l∆∞·ª£ng bao trung b√¨nh
            const totalWeight = totalWeightInput; // T·ªïng tr·ªçng l∆∞·ª£ng

            const newTotalImported = (currentData.totalImported || 0) + quantity;
            const newCurrentQuantity = (currentData.currentQuantity || 0) + quantity;

            const materialRef = doc(getInventoryCollectionRef(), locationId);

            // LOGIC NEW: ƒê·∫∑t fifoDate
            let newFifoDate = currentData.fifoDate;
            const locationWasEmpty = (currentData.currentQuantity || 0) === 0;

            if (isNewMaterial || locationWasEmpty) {
                 // N·∫øu l√† v·∫≠t li·ªáu m·ªõi (ch∆∞a t·ª´ng c√≥ t√™n) ho·∫∑c v·ªã tr√≠ v·ª´a h·∫øt h√†ng, ƒë·∫∑t ng√†y FIFO m·ªõi
                 newFifoDate = new Date().toISOString(); 
            } else if (currentData.materialName && currentData.materialName !== materialName) {
                 // N·∫øu ƒëang c√≥ h√†ng nh∆∞ng nh·∫≠p v·∫≠t li·ªáu kh√°c (C·∫£nh b√°o ng∆∞·ªùi d√πng n√™n xu·∫•t h·∫øt tr∆∞·ªõc)
                 newFifoDate = new Date().toISOString();
                 console.warn("V·ªã tr√≠ n√†y ƒëang ch·ª©a nguy√™n li·ªáu kh√°c. FIFO date ƒë√£ ƒë∆∞·ª£c reset.");
            } else {
                newFifoDate = currentData.fifoDate; // Gi·ªØ nguy√™n ng√†y FIFO c≈© (FIFO cho h√†ng c≈©)
            }


            try {
                // 1. C·∫≠p nh·∫≠t (ho·∫∑c t·∫°o m·ªõi) th√¥ng tin th·∫ª kho
                const updateData = {
                    materialName: materialName,
                    unitWeight: unitWeight,
                    supplier: supplier,
                    unit: unit,
                    lotNo: lotNo, 
                    totalImported: newTotalImported,
                    currentQuantity: newCurrentQuantity,
                    updatedAt: serverTimestamp(),
                    note: note,
                    fifoDate: newFifoDate // L∆∞u ng√†y FIFO
                };
                
                if (isNewMaterial) {
                    await setDoc(materialRef, updateData);
                } else {
                    await updateDoc(materialRef, updateData);
                }

                // 2. Ghi v√†o l·ªãch s·ª≠
                const historyRef = doc(collection(getInventoryCollectionRef(), locationId, 'history'), 'default_history_doc');
                const historyEntry = {
                    type: 'import',
                    date: new Date().toISOString(),
                    lotNo: lotNo,
                    unit: unit, 
                    quantity: quantity,
                    bagWeight: bagWeight, // Tr·ªçng l∆∞·ª£ng bao (trung b√¨nh) ƒë√£ t√≠nh to√°n
                    totalWeight: totalWeight, // Tr·ªçng l∆∞·ª£ng t·ªïng ƒë√£ nh·∫≠p
                    location: locationId,
                    checker: loggedInUser,
                    note: note
                };
                
                await updateDoc(historyRef, {
                    entries: arrayUnion(historyEntry)
                }).catch(async (e) => {
                    if (e.code === 'not-found' || e.message.includes('No document to update')) {
                         await setDoc(historyRef, { entries: [historyEntry] });
                    } else {
                         throw e;
                    }
                });

                showSimpleModal('Nh·∫≠p Kho Th√†nh C√¥ng', `ƒê√£ nh·∫≠p ${quantity} ${unit} ${materialName} (T·ªïng ${totalWeight.toFixed(2)} kg) v√†o v·ªã tr√≠ ${locationId}.`);
                window.closeModal();
            } catch (error) {
                console.error("L·ªói khi nh·∫≠p kho:", error);
                showSimpleModal('L·ªói', `Kh√¥ng th·ªÉ th·ª±c hi·ªán nh·∫≠p kho: ${error.message}`);
            }
        };

        // --- H√ÄM XU·∫§T EXCEL T·ªîNG H·ª¢P (M·ªöI) ---
        window.exportInventoryReport = () => {
            // 1. L·∫•y v√† x·ª≠ l√Ω d·ªØ li·ªáu (gi·ªëng h·ªát renderReports)
            const reportItems = Object.entries(inventoryData)
                .filter(([id, data]) => data && data.materialName && data.currentQuantity > 0)
                .map(([locationId, data]) => {
                    const totalWeight = (data.currentQuantity || 0) * (data.unitWeight || 0);
                    return { ...data, locationId, totalWeight };
                })
                .sort((a, b) => {
                    if (a.materialName < b.materialName) return -1;
                    if (a.materialName > b.materialName) return 1;
                    const dateA = new Date(a.fifoDate || 0).getTime();
                    const dateB = new Date(b.fifoDate || 0).getTime();
                    return dateA - dateB;
                });

            if (reportItems.length === 0) {
                showSimpleModal('L·ªói', 'Kh√¥ng c√≥ d·ªØ li·ªáu t·ªìn kho ƒë·ªÉ xu·∫•t b√°o c√°o.');
                return;
            }

            // 2. D·ªØ li·ªáu c·ªë ƒë·ªãnh (Ti√™u ƒë·ªÅ) - Theo m·∫´u image
            const excelHeader = [
                ['C√îNG TY C·ªî PH·∫¶N CHƒÇN NU√îI C.P. VI·ªÜT NAM - CHI NH√ÅNH NM2 T·∫†I B√åNH PH∆Ø·ªöC'], // A1
                ['C.P. VIET NAM CORPORATION - BINH PHUOC Factory 2'], // A2
                ['Ph√≤ng Kho Nguy√™n Li·ªáu'], // A3
                ['Raw Material Warehouse Department'], // A4
                [''], // A5
                ['B√ÅO C√ÅO KI·ªÇM KHO NGUY√äN LI·ªÜU, CH·∫§T PH·ª§ GIA, PREMIX'], // A6
                ['RAW MATERIAL, ADDITIVES, AND PREMIX INVENTORY REPORT'], // A7
                [''], // A8 (D√≤ng tr·ªëng)
                // Ti√™u ƒë·ªÅ b·∫£ng
                ['STT', 'T√™n nguy√™n li·ªáu', 'Ng√†y nh·∫≠p', 'Tr·ªçng l∆∞·ª£ng bao', 'V·ªã tr√≠', 'S·ªë bao', 'Tr·ªçng l∆∞·ª£ng (kg)', 'Ghi ch√∫'],
                ['Item', 'Raw Material Name', 'Import Date', 'Bag Weight', 'Location', 'Number of Bags', 'Weight (kg)', 'Notes']
            ];

            // 3. D·ªØ li·ªáu c√°c d√≤ng
            const transactionRows = reportItems.map((item, index) => [
                index + 1, // STT
                item.materialName, // T√™n nguy√™n li·ªáu
                item.fifoDate ? new Date(item.fifoDate).toLocaleDateString('vi-VN') : '', // Ng√†y nh·∫≠p
                item.unitWeight ? item.unitWeight.toFixed(2) : '', // Tr·ªçng l∆∞·ª£ng bao
                item.locationId, // V·ªã tr√≠
                item.currentQuantity, // S·ªë bao
                item.totalWeight.toFixed(2), // Tr·ªçng l∆∞·ª£ng (kg)
                item.note || '' // Ghi ch√∫
            ]);
            
            const finalData = excelHeader.concat(transactionRows);

            // 4. T·∫°o Worksheet
            const ws = XLSX.utils.aoa_to_sheet(finalData);

            // 5. Merge Cells
            const merges = [
                { s: { r: 0, c: 0 }, e: { r: 0, c: 7 } }, // A1:H1
                { s: { r: 1, c: 0 }, e: { r: 1, c: 7 } }, // A2:H2
                { s: { r: 2, c: 0 }, e: { r: 2, c: 7 } }, // A3:H3
                { s: { r: 3, c: 0 }, e: { r: 3, c: 7 } }, // A4:H4
                { s: { r: 5, c: 0 }, e: { r: 5, c: 7 } }, // A6:H6
                { s: { r: 6, c: 0 }, e: { r: 6, c: 7 } }, // A7:H7
            ];
            ws['!merges'] = merges;

            // 6. Chi·ªÅu r·ªông c·ªôt
            const wscols = [
                { wch: 5 },  // STT
                { wch: 25 }, // T√™n nguy√™n li·ªáu
                { wch: 15 }, // Ng√†y nh·∫≠p
                { wch: 15 }, // Tr·ªçng l∆∞·ª£ng bao
                { wch: 15 }, // V·ªã tr√≠
                { wch: 12 }, // S·ªë bao
                { wch: 15 }, // Tr·ªçng l∆∞·ª£ng (kg)
                { wch: 25 }  // Ghi ch√∫
            ];
            ws['!cols'] = wscols;

            // 7. Styling (ƒê∆°n gi·∫£n h∆°n th·∫ª kho, ch·ªß y·∫øu l√† header)
            const BORDER_ALL = {
                top: { style: "thin" }, bottom: { style: "thin" },
                left: { style: "thin" }, right: { style: "thin" }
            };
            const CENTER_WRAP = { alignment: { horizontal: 'center', vertical: 'center', wrapText: true } };
            const LEFT_WRAP = { alignment: { horizontal: 'left', vertical: 'center', wrapText: true } };
            
            const getCellRef = (r, c) => XLSX.utils.encode_cell({ r: r, c: c });

            const applyStyle = (range, style) => {
                for(let R = range.s.r; R <= range.e.r; ++R) {
                    for(let C = range.s.c; C <= range.e.c; ++C) {
                        const cellref = getCellRef(R, C);
                        if(!ws[cellref]) ws[cellref] = {};
                        ws[cellref].s = { ...ws[cellref].s, ...style };
                    }
                }
            };

            // Style Ti√™u ƒë·ªÅ C√¥ng ty (A1:A7)
            for(let R = 0; R <= 6; R++) {
                if(R === 4) continue; // B·ªè qua d√≤ng tr·ªëng A5
                const ref = getCellRef(R, 0);
                if(!ws[ref]) ws[ref] = {};
                ws[ref].s = { 
                    font: { bold: true, size: 12, name: 'Times New Roman' }, 
                    alignment: { horizontal: 'center', vertical: 'center' }
                };
            }
            // Ti√™u ƒë·ªÅ b√°o c√°o (A6, A7) m√†u xanh
            applyStyle({ s: { r: 5, c: 0 }, e: { r: 6, c: 0 } }, { font: { color: { rgb: "FF0000FF" } } }); // Blue

            // Style Ti√™u ƒë·ªÅ B·∫£ng (H√†ng 9-10)
            const headerRange = { s: { r: 8, c: 0 }, e: { r: 9, c: 7 } };
            applyStyle(headerRange, { 
                border: BORDER_ALL, 
                font: { bold: true, name: 'Times New Roman' },
                fill: { fgColor: { rgb: "FFD9D9D9" } }, // X√°m nh·∫°t
                alignment: { horizontal: 'center', vertical: 'center', wrapText: true }
            });

            // Style D·ªØ li·ªáu Giao d·ªãch
            const dataStartRow = 10;
            const dataEndRow = dataStartRow + transactionRows.length - 1;
            if (transactionRows.length > 0) {
                const dataRange = { s: { r: dataStartRow, c: 0 }, e: { r: dataEndRow, c: 7 } };
                applyStyle(dataRange, { border: BORDER_ALL, font: { name: 'Times New Roman' } });
                
                // CƒÉn tr√°i
                applyStyle({ s: { r: dataStartRow, c: 1 }, e: { r: dataEndRow, c: 1 } }, LEFT_WRAP); // T√™n
                applyStyle({ s: { r: dataStartRow, c: 7 }, e: { r: dataEndRow, c: 7 } }, LEFT_WRAP); // Ghi ch√∫
                
                // CƒÉn gi·ªØa cho STT, Ng√†y nh·∫≠p, V·ªã tr√≠
                applyStyle({ s: { r: dataStartRow, c: 0 }, e: { r: dataEndRow, c: 0 } }, CENTER_WRAP); // STT
                applyStyle({ s: { r: dataStartRow, c: 2 }, e: { r: dataEndRow, c: 2 } }, CENTER_WRAP); // Ng√†y nh·∫≠p
                applyStyle({ s: { r: dataStartRow, c: 4 }, e: { r: dataEndRow, c: 4 } }, CENTER_WRAP); // V·ªã tr√≠

                // CƒÉn ph·∫£i cho s·ªë
                const numberStyle = { alignment: { horizontal: 'right', vertical: 'center' }, numFmt: '0.00' };
                applyStyle({ s: { r: dataStartRow, c: 3 }, e: { r: dataEndRow, c: 3 } }, numberStyle); // Tr·ªçng l∆∞·ª£ng bao
                applyStyle({ s: { r: dataStartRow, c: 5 }, e: { r: dataEndRow, c: 5 } }, { ...numberStyle, numFmt: '0' }); // S·ªë bao
                applyStyle({ s: { r: dataStartRow, c: 6 }, e: { r: dataEndRow, c: 6 } }, numberStyle); // Tr·ªçng l∆∞·ª£ng (kg)
            }

            // 8. Xu·∫•t file
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Bao Cao Ton Kho");
            XLSX.writeFile(wb, `Bao_Cao_Ton_Kho_Tong_Hop_${new Date().toISOString().split('T')[0]}.xlsx`);
            showSimpleModal('Xu·∫•t File Th√†nh C√¥ng', `ƒê√£ xu·∫•t B√°o C√°o T·ªìn Kho T·ªïng H·ª£p.`);
        };


        // --- H√ÄM XU·∫§T EXCEL (C·∫¨P NH·∫¨T STYLE V√Ä FORMAT) ---
        window.exportToExcel = (locationId) => {
            const data = inventoryData[locationId];
            if (!data) {
                showSimpleModal('L·ªói', 'Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu t·ªìn kho cho v·ªã tr√≠ n√†y.');
                return;
            }
            if (currentModalHistory.length === 0) {
                 showSimpleModal('L·ªói', 'Kh√¥ng c√≥ l·ªãch s·ª≠ nh·∫≠p/xu·∫•t ƒë·ªÉ xu·∫•t b√°o c√°o.');
                 return;
            }

            // D·ªØ li·ªáu chung
            const materialName = data.materialName || 'N/A';
            const unit = data.unit || 'N/A';
            const unitWeight = data.unitWeight || 0;
            const lotNo = data.lotNo || 'N/A';
            const storageLocation = locationId;

            // X·ª≠ l√Ω d·ªØ li·ªáu l·ªãch s·ª≠ ƒë·ªÉ t√≠nh t·ªìn kho l≈©y k·∫ø (T·ªìn cu·ªëi c√πng l√† currentData)
            const sortedHistory = [...currentModalHistory].sort((a, b) => new Date(a.date) - new Date(b.date));
            
            let currentBags = 0; // S·ªë bao t·ªìn l≈©y k·∫ø
            let currentWeight = 0; // Tr·ªçng l∆∞·ª£ng t·ªìn l≈©y k·∫ø
            
            const exportData = [];
            
            // X·ª≠ l√Ω t·ª´ng giao d·ªãch
            sortedHistory.forEach(entry => {
                let quantityExported = 0; // S·ªë l∆∞·ª£ng ƒë∆°n v·ªã xu·∫•t (t√≠nh to√°n)
                
                const row = {
                    'Ng√†y nh·∫≠p': entry.type === 'import' ? new Date(entry.date).toLocaleDateString('vi-VN') : '',
                    'V·ªã tr√≠ l∆∞u kho': storageLocation,
                    'Lot No': entry.type === 'import' ? entry.lotNo : '',
                    
                    // NH·∫¨P / RECEIVE
                    'S·ªë bao (Nh·∫≠p)': entry.type === 'import' ? entry.quantity : '',
                    'Tr·ªçng l∆∞·ª£ng bao (kg)': entry.type === 'import' ? entry.bagWeight.toFixed(2) : '', // L·∫•y tr·ªçng l∆∞·ª£ng trung b√¨nh
                    'Tr·ªçng l∆∞·ª£ng t·ªïng (kg)': entry.type === 'import' ? entry.totalWeight.toFixed(2) : '', // L·∫•y t·ª´ d·ªØ li·ªáu l·ªãch s·ª≠
                    
                    // XU·∫§T / EXPORT
                    'Ng√†y xu·∫•t': entry.type === 'export' ? new Date(entry.date).toLocaleDateString('vi-VN') : '',
                    'S·ªë bao (Xu·∫•t)': entry.type === 'export' ? entry.numBags : '',
                    'Tr·ªçng l∆∞·ª£ng bao (Xu·∫•t)': entry.type === 'export' ? (entry.weight / entry.numBags).toFixed(2) : '', // Tr·ªçng l∆∞·ª£ng trung b√¨nh
                    'Ng∆∞·ªùi ki·ªÉm': entry.type === 'export' ? entry.checker : '',

                    // T·ªíN / INVENTORY (T√≠nh to√°n l≈©y k·∫ø)
                    'S·ªë bao (T·ªìn)': 0,
                    'Tr·ªçng l∆∞·ª£ng (kg) (T·ªìn)': 0,
                    
                    // Ghi ch√∫
                    'GHI CH√ö': entry.note || '',
                };

                if (entry.type === 'import') {
                    const bags = entry.quantity;
                    const weight = entry.totalWeight; // D√πng tr·ªçng l∆∞·ª£ng t·ªïng ƒë√£ l∆∞u
                    currentBags += bags;
                    currentWeight += weight;
                } else if (entry.type === 'export') {
                    const bags = entry.numBags;
                    const weight = entry.weight;
                    currentBags -= bags;
                    currentWeight -= weight;
                }
                
                // C·∫≠p nh·∫≠t gi√° tr·ªã t·ªìn l≈©y k·∫ø sau giao d·ªãch
                row['S·ªë bao (T·ªìn)'] = Math.round(currentBags);
                row['Tr·ªçng l∆∞·ª£ng (kg) (T·ªìn)'] = Math.round(currentWeight);

                exportData.push(row);
            });
            
            // --- B∆Ø·ªöC 1: X√¢y d·ª±ng c·∫•u tr√∫c d·ªØ li·ªáu cho Excel (gi·ªëng h·ªát h√¨nh ·∫£nh) ---
            
            // 1. D·ªØ li·ªáu c·ªë ƒë·ªãnh (Ti√™u ƒë·ªÅ)
            const excelHeader = [
                ['C√îNG TY C·ªî PH·∫¶N CHƒÇN NU√îI C.P. VI·ªÜT NAM - CHI NH√ÅNH NM2 T·∫†I B√åNH PH∆Ø·ªöC'], // A1
                ['C.P. VIET NAM CORPORATION - BINH PHUOC Factory 2'], // A2
                ['Ph√≤ng Kho Nguy√™n Li·ªáu'], // A3
                ['Raw Material Warehouse Department'], // A4
                [''], // A5 (D√≤ng tr·ªëng)
                ['T√™n nguy√™n li·ªáu/Raw Material Name:', materialName, ''], // A6, B6
                [''], // A7 (D√≤ng tr·ªëng)

                // H√†ng 8 - Ti√™u ƒë·ªÅ 1 (Merge)
                ['Ng√†y nh·∫≠p', 'V·ªã tr√≠ l∆∞u kho', 'Lot No', 'NH·∫¨P / RECEIVE', '', '', 'XU·∫§T / EXPORT', '', '', '', 'T·ªíN / INVENTORY', '', 'GHI CH√ö / NOTES'], 
                
                // H√†ng 9 - Ti√™u ƒë·ªÅ 2
                ['Import Date', 'Storage Location', 'Lot No', 'S·ªë bao', 'Tr·ªçng l∆∞·ª£ng bao', 'Tr·ªçng l∆∞·ª£ng t·ªïng', 'Ng√†y xu·∫•t', 'S·ªë bao', 'Tr·ªçng l∆∞·ª£ng bao', 'Ng∆∞·ªùi ki·ªÉm', 'S·ªë bao', 'Tr·ªçng l∆∞·ª£ng (kg)', 'NOTES'], 
                
                // H√†ng 10 - Ti√™u ƒë·ªÅ 3
                ['', '', '', 'Number of Bags', 'Bag Weight (kg)', 'Weight Total (kg)', 'Export Date', 'Number of Bags', 'Bag Weight (kg)', 'Inspector', 'Number of Bags', 'Weight (kg)', ''],
            ];

            // D·ªØ li·ªáu c√°c d√≤ng giao d·ªãch
            const transactionRows = exportData.map(row => [
                row['Ng√†y nh·∫≠p'],
                row['V·ªã tr√≠ l∆∞u kho'],
                row['Lot No'],
                row['S·ªë bao (Nh·∫≠p)'],
                row['Tr·ªçng l∆∞·ª£ng bao (kg)'],
                row['Tr·ªçng l∆∞·ª£ng t·ªïng (kg)'],
                row['Ng√†y xu·∫•t'],
                row['S·ªë bao (Xu·∫•t)'],
                row['Tr·ªçng l∆∞·ª£ng bao (Xu·∫•t)'],
                row['Ng∆∞·ªùi ki·ªÉm'],
                row['S·ªë bao (T·ªìn)'],
                row['Tr·ªçng l∆∞·ª£ng (kg) (T·ªìn)'],
                row['GHI CH√ö']
            ]);

            const finalData = excelHeader.concat(transactionRows);

            // --- B∆Ø·ªöC 2: T·∫°o Workbook v√† Worksheet ---
            const ws = XLSX.utils.aoa_to_sheet(finalData);
            
            // --- B∆Ø·ªöC 3: Merge Cells (Gi·ªØ nguy√™n nh∆∞ c≈©) ---
            ws['!merges'] = [
                { s: { r: 0, c: 0 }, e: { r: 0, c: 12 } }, // A1:M1 - C√¥ng ty
                { s: { r: 1, c: 0 }, e: { r: 1, c: 12 } }, // A2:M2 - CP
                { s: { r: 2, c: 0 }, e: { r: 2, c: 12 } }, // A3:M3 - Ph√≤ng Kho
                { s: { r: 3, c: 0 }, e: { r: 3, c: 12 } }, // A4:M4 - Raw Material
                
                { s: { r: 7, c: 3 }, e: { r: 7, c: 5 } },  // D8:F8 - NH·∫¨P / RECEIVE
                { s: { r: 7, c: 6 }, e: { r: 7, c: 9 } },  // G8:J8 - XU·∫§T / EXPORT
                { s: { r: 7, c: 10 }, e: { r: 7, c: 11 } },// K8:L8 - T·ªíN / INVENTORY
                { s: { r: 7, c: 12 }, e: { r: 9, c: 12 } },// M8:M10 - GHI CH√ö
                
                { s: { r: 7, c: 0 }, e: { r: 9, c: 0 } },  // A8:A10 - Ng√†y nh·∫≠p
                { s: { r: 7, c: 1 }, e: { r: 9, c: 1 } },  // B8:B10 - V·ªã tr√≠ l∆∞u kho
                { s: { r: 7, c: 2 }, e: { r: 9, c: 2 } },  // C8:C10 - Lot No
                
                // Merge cho c√°c √¥ ti√™u ƒë·ªÅ con 2 d√≤ng (H√†ng 8-9)
                { s: { r: 8, c: 3 }, e: { r: 9, c: 3 } }, // D9:D10 - S·ªë bao nh·∫≠p
                { s: { r: 8, c: 4 }, e: { r: 9, c: 4 } }, // E9:E10 - Tr·ªçng l∆∞·ª£ng bao (kg)
                { s: { r: 8, c: 5 }, e: { r: 9, c: 5 } }, // F9:F10 - Tr·ªçng l∆∞·ª£ng t·ªïng (kg)

                { s: { r: 7, c: 6 }, e: { r: 9, c: 6 } }, // G8:G10 - Ng√†y xu·∫•t (ƒê√£ merge ·ªü tr√™n)
                
                { s: { r: 8, c: 7 }, e: { r: 9, c: 7 } }, // H9:H10 - S·ªë bao xu·∫•t
                { s: { r: 8, c: 8 }, e: { r: 9, c: 8 } }, // I9:I10 - Tr·ªçng l∆∞·ª£ng bao (Xu·∫•t)
                { s: { r: 8, c: 9 }, e: { r: 9, c: 9 } }, // J9:J10 - Ng∆∞·ªùi ki·ªÉm
                
                { s: { r: 8, c: 10 }, e: { r: 9, c: 10 } }, // K9:K10 - S·ªë bao t·ªìn
                { s: { r: 8, c: 11 }, e: { r: 9, c: 11 } }, // L9:L10 - Tr·ªçng l∆∞·ª£ng (T·ªìn)
                
                // Merge cho T√™n Nguy√™n Li·ªáu: B6:M6
                { s: { r: 5, c: 1 }, e: { r: 5, c: 12 } },
            ];
            
            // C·∫≠p nh·∫≠t l·∫°i T√™n Nguy√™n Li·ªáu sau khi merge (A6, B6)
            XLSX.utils.sheet_add_aoa(ws, [
                ['T√™n nguy√™n li·ªáu/Raw Material Name:', materialName]
            ], { origin: 'A6' });
            

            // --- B∆Ø·ªöC 4: Thi·∫øt l·∫≠p chi·ªÅu r·ªông c·ªôt ---
            const wscols = [
                { wch: 15 }, { wch: 15 }, { wch: 12 }, 
                { wch: 12 }, { wch: 15 }, { wch: 15 }, 
                { wch: 15 }, { wch: 12 }, { wch: 15 }, 
                { wch: 12 }, { wch: 12 }, { wch: 15 }, 
                { wch: 25 }
            ];
            ws['!cols'] = wscols;

            // --- B∆Ø·ªöC 5: ƒê·ªãnh d·∫°ng m√†u s·∫Øc v√† border (THEO H√åNH ·∫¢NH) ---

            // M√†u s·∫Øc
            const BLUE_BG = "FFDDEBF7"; // Xanh nh·∫°t cho NH·∫¨P (D8:F10)
            const YELLOW_BG = "FFFFE599"; // V√†ng nh·∫°t cho XU·∫§T (G8:J10)
            const GREEN_BG = "FFC6E0B4"; // Xanh l√° nh·∫°t cho T·ªíN (K8:L10)
            const HEADER_BG = "FFD9D9D9"; // X√°m nh·∫°t cho ti√™u ƒë·ªÅ 1 (A8:M8)
            const CENTER_WRAP = { alignment: { horizontal: 'center', vertical: 'center', wrapText: true } };
            const LEFT_WRAP = { alignment: { horizontal: 'left', vertical: 'center', wrapText: true } };
            const BORDER_ALL = {
                top: { style: "thin" }, bottom: { style: "thin" },
                left: { style: "thin" }, right: { style: "thin" }
            };
            const BORDER_HEAVY = {
                top: { style: "medium" }, bottom: { style: "medium" },
                left: { style: "medium" }, right: { style: "medium" }
            };
            
            // H√†m l·∫•y t√™n √¥ theo t·ªça ƒë·ªô (v√≠ d·ª•: 0, 0 -> A1)
            const getCellRef = (r, c) => XLSX.utils.encode_cell({ r: r, c: c });
            
            // √Åp d·ª•ng style cho t·ª´ng v√πng √¥
            const applyStyle = (range, style) => {
                for(let R = range.s.r; R <= range.e.r; ++R) {
                    for(let C = range.s.c; C <= range.e.c; ++C) {
                        const cellref = getCellRef(R, C);
                        if(!ws[cellref]) ws[cellref] = {};
                        ws[cellref].s = { ...ws[cellref].s, ...style };
                    }
                }
            };
            
            // --- 5.1 Style Ti√™u ƒë·ªÅ C√¥ng ty (A1:A4) ---
            for(let R = 0; R <= 3; R++) {
                const ref = getCellRef(R, 0);
                if(!ws[ref]) ws[ref] = {};
                ws[ref].s = { 
                    font: { bold: true, size: 12, name: 'Times New Roman' }, 
                    alignment: { horizontal: 'center', vertical: 'center' }
                };
            }
            
            // --- 5.2 Style Th√¥ng tin Nguy√™n Li·ªáu (A6:M6) ---
            applyStyle({ s: { r: 5, c: 0 }, e: { r: 5, c: 0 } }, { font: { bold: true, name: 'Times New Roman' }, alignment: { horizontal: 'left', vertical: 'center' }}); // A6: Ti√™u ƒë·ªÅ c·ªë ƒë·ªãnh
            applyStyle({ s: { r: 5, c: 1 }, e: { r: 5, c: 12 } }, { font: { bold: true, size: 11, name: 'Times New Roman', color: { rgb: "FF0000FF" } }, alignment: { horizontal: 'left', vertical: 'center' }}); // B6: D·ªØ li·ªáu Nguy√™n Li·ªáu (M√†u xanh ƒë·∫≠m)
            
            // --- 5.3 Style Ti√™u ƒë·ªÅ B·∫£ng (H√†ng 8-10) ---
            const headerRange = { s: { r: 7, c: 0 }, e: { r: 9, c: 12 } };
            
            // Border d√†y cho to√†n b·ªô khu v·ª±c ti√™u ƒë·ªÅ (A8:M10)
            applyStyle(headerRange, { border: BORDER_HEAVY, font: { bold: true, name: 'Times New Roman' } });
            
            // N·ªÅn X√°m cho Ti√™u ƒë·ªÅ 1 (A8:M8)
            applyStyle({ s: { r: 7, c: 0 }, e: { r: 7, c: 12 } }, { fill: { fgColor: { rgb: HEADER_BG } } });

            // N·ªÅn Xanh, V√†ng, Xanh l√° cho khu v·ª±c Ti√™u ƒë·ªÅ 2 & 3 (H√†ng 9-10)
            applyStyle({ s: { r: 8, c: 3 }, e: { r: 9, c: 5 } }, { fill: { fgColor: { rgb: BLUE_BG } } });   // NH·∫¨P
            applyStyle({ s: { r: 8, c: 6 }, e: { r: 9, c: 9 } }, { fill: { fgColor: { rgb: YELLOW_BG } } }); // XU·∫§T
            applyStyle({ s: { r: 8, c: 10 }, e: { r: 9, c: 11 } }, { fill: { fgColor: { rgb: GREEN_BG } } });// T·ªíN
            
            // CƒÉn gi·ªØa cho to√†n b·ªô ti√™u ƒë·ªÅ
            applyStyle(headerRange, CENTER_WRAP);

            // --- 5.4 Style D·ªØ li·ªáu Giao d·ªãch (T·ª´ H√†ng 11 tr·ªü ƒëi) ---
            const dataStartRow = 10;
            const dataEndRow = dataStartRow + transactionRows.length - 1;
            const dataRange = { s: { r: dataStartRow, c: 0 }, e: { r: dataEndRow, c: 12 } };

            if (transactionRows.length > 0) {
                 // Font v√† Border m·ªèng cho to√†n b·ªô d·ªØ li·ªáu
                applyStyle(dataRange, { border: BORDER_ALL, font: { name: 'Times New Roman' } });
                
                // CƒÉn gi·ªØa cho c√°c c·ªôt A, B, C (Ng√†y, V·ªã tr√≠, Lot)
                applyStyle({ s: { r: dataStartRow, c: 0 }, e: { r: dataEndRow, c: 2 } }, CENTER_WRAP);
                
                // CƒÉn gi·ªØa cho c√°c c·ªôt G, J (Ng√†y xu·∫•t, Ng∆∞·ªùi ki·ªÉm)
                applyStyle({ s: { r: dataStartRow, c: 6 }, e: { r: dataEndRow, c: 6 } }, CENTER_WRAP);
                applyStyle({ s: { r: dataStartRow, c: 9 }, e: { r: dataEndRow, c: 9 } }, CENTER_WRAP);
                
                // CƒÉn ph·∫£i cho c√°c c·ªôt S·ªë/Tr·ªçng l∆∞·ª£ng (D-F, H-I, K-L)
                const numberStyle = { alignment: { horizontal: 'right', vertical: 'center' }, numFmt: '0.00' };
                applyStyle({ s: { r: dataStartRow, c: 3 }, e: { r: dataEndRow, c: 5 } }, numberStyle);
                applyStyle({ s: { r: dataStartRow, c: 7 }, e: { r: dataEndRow, c: 8 } }, numberStyle);
                applyStyle({ s: { r: dataStartRow, c: 10 }, e: { r: dataEndRow, c: 11 } }, numberStyle);
                
                // C·ªôt Ghi ch√∫ (M) - CƒÉn tr√°i
                applyStyle({ s: { r: dataStartRow, c: 12 }, e: { r: dataEndRow, c: 12 } }, LEFT_WRAP);
            }
            
            // --- C·∫¨P NH·∫¨T T√äN C·ªòT ƒê√öNG CHO TI√äU ƒê·ªÄ 2 & 3 ---
            XLSX.utils.sheet_add_aoa(ws, [
                ['Import Date', 'Storage Location', 'Lot No', 'S·ªë bao', 'Tr·ªçng l∆∞·ª£ng bao', 'Tr·ªçng l∆∞·ª£ng t·ªïng', 'Ng√†y xu·∫•t', 'S·ªë bao', 'Tr·ªçng l∆∞·ª£ng bao', 'Ng∆∞·ªùi ki·ªÉm', 'S·ªë bao', 'Tr·ªçng l∆∞·ª£ng (kg)', 'NOTES'], 
                ['', '', '', 'Number of Bags', 'Bag Weight (kg)', 'Weight Total (kg)', 'Export Date', 'Number of Bags', 'Bag Weight (kg)', 'Inspector', 'Number of Bags', 'Weight (kg)', ''],
            ], { origin: 'A9' });


            // --- B∆Ø·ªöC 6: T·∫°o Workbook v√† Xu·∫•t file ---
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Th·∫ª Kho");
            
            // Xu·∫•t file
            XLSX.writeFile(wb, `The_Kho_${locationId}_${materialName.replace(/ /g, '_')}.xlsx`);
            showSimpleModal('Xu·∫•t File Th√†nh C√¥ng', `ƒê√£ xu·∫•t d·ªØ li·ªáu th·∫ª kho ${locationId} ra file Excel v·ªõi ƒë·ªãnh d·∫°ng m√†u s·∫Øc ƒë·∫ßy ƒë·ªß.`);
        };


        // --- H√ÄM MODAL ƒê∆†N GI·∫¢N (THAY TH·∫æ ALERT) ---

        const simpleModal = document.getElementById('simple-modal');
        const simpleModalTitle = document.getElementById('simple-modal-title');
        const simpleModalBody = document.getElementById('simple-modal-body');

        function showSimpleModal(title, message) {
            simpleModalTitle.innerText = title;
            simpleModalBody.innerText = message;
            simpleModal.classList.remove('hidden');
        }

        window.closeSimpleModal = () => {
            simpleModal.classList.add('hidden');
        };
        
        // Kh·ªüi ƒë·ªông ·ª©ng d·ª•ng
        window.onload = renderApp;

    </script>

    <!-- CONTAINER CH√çNH -->
    <div id="app-container">
        <!-- N·ªôi dung s·∫Ω ƒë∆∞·ª£c ch√®n b·ªüi JavaScript -->
    </div>

    <!-- Modal Chi Ti·∫øt Th·∫ª Kho (Complex Modal) -->
    <div id="location-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 z-50 flex items-center justify-center p-4 transition-opacity duration-300">
        <div class="bg-white p-6 card max-w-5xl w-full transform transition-all duration-300 scale-100 overflow-y-auto max-h-[90vh]">
            <div id="location-modal-content">
                <!-- N·ªôi dung ƒë∆∞·ª£c ch√®n b·ªüi window.showLocationModal -->
            </div>
        </div>
    </div>
    
    <!-- Modal Th√¥ng B√°o ƒê∆°n Gi·∫£n (Simple Modal) -->
    <div id="simple-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 z-50 flex items-center justify-center transition-opacity duration-300">
        <div class="bg-white p-6 card max-w-sm w-full transform transition-all duration-300 scale-100">
            <h3 id="simple-modal-title" class="text-xl font-bold text-gray-800 mb-4">Th√¥ng B√°o</h3>
            <p id="simple-modal-body" class="text-gray-600 mb-6"></p>
            <div class="flex justify-end">
                <button onclick="window.closeSimpleModal()" class="px-4 py-2 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition duration-150">OK</button>
            </div>
        </div>
    </div>
</body>
</html>